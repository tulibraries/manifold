<% content_for(:title) { "New Form Submissions" } %>

<header class="main-content__header">
  <h1 class="main-content__page-title">
    <%= content_for(:title) %>
  </h1>
  
  <div class="main-content__header-actions">
    <%= link_to "Export CSV", export_csv_admin_form_submissions_path(format: :csv), 
        class: "button button--export",
        title: "Download all submissions as CSV for Excel" %>
  </div>
</header>

<section class="main-content__body main-content__body--flush">
  <% if @form_submissions.any? %>
    <div class="table">
      <table class="table__table">
        <thead>
          <tr class="table__row table__row--header">
            <th class="table__header cell cell--header">ID</th>
            <th class="table__header cell cell--header">Submitted</th>
            <th class="table__header cell cell--header">Name</th>
            <th class="table__header cell cell--header">Email</th>
            <th class="table__header cell cell--header">Department</th>
            <th class="table__header cell cell--header">Requests</th>
          </tr>
        </thead>
        <tbody>
          <% @form_submissions.each do |submission| %>
            <tr class="table__row table__row--clickable" onclick="window.location='<%= admin_form_submission_path(submission) %>'">
              <td class="cell cell--integer">
                #<%= submission.id %>
              </td>
              <td class="cell cell--date-time">
                <%= submission.created_at.strftime('%m/%d/%Y %l:%M %p') %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <%= attributes['name'] || 'N/A' %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <%= attributes['email'] || 'N/A' %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <%= attributes['department'] || 'N/A' %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <% request_count = 0 %>
                  <% (0..9).each do |i| %>
                    <% field_name = i == 0 ? 'request_title' : "request_title_#{i.to_s.rjust(2, '0')}" %>
                    <% if attributes[field_name].present? %>
                      <% request_count += 1 %>
                    <% end %>
                  <% end %>
                  <%= pluralize(request_count, 'request') %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="table">
      <div class="table__empty-state">
        <p class="table__empty-text">
          No new form submissions found.
        </p>
      </div>
    </div>
  <% end %>
</section>

<style>
  .button--export {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
  }
  
  .button--export:hover {
    background-color: #218838;
    border-color: #1e7e34;
  }
  
  .main-content__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .main-content__header-actions {
    margin-left: auto;
  }
  
  .table__row--clickable {
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .table__row--clickable:hover {
    background-color: #f8f9fa;
  }
  
  .table__row--clickable:hover .cell {
    background-color: transparent;
  }
</style>
