<% form_type_display = @form_submission.form_type == 'av-requests' ? 'AV Request' : 'Copy Request' %>
<% content_for(:title) { "#{form_type_display} ##{@form_submission.id}" } %>

<header class="main-content__header">
  <h1 class="main-content__page-title">
    <%= content_for(:title) %>
  </h1>
  
  <div class="main-content__header-actions">
    <%= link_to "← Back to List", admin_form_submissions_path, class: "button" %>
  </div>
</header>

<section class="main-content__body">
  <% raw_attributes = @form_submission.form_attributes %>
  <% # Handle nested form structure - extract from 'form' key if present %>
  <% attributes = raw_attributes['form'] || raw_attributes %>
    
    <!-- Submission Details -->
    <dl class="attribute-list">      
      <dt class="attribute-list__key">Submitted At</dt>
      <dd class="attribute-list__value"><%= @form_submission.created_at.strftime('%B %d, %Y at %l:%M %p') %></dd>
    </dl>

    <hr class="divider">

    <!-- Personal Information -->
    <h2 class="section-title">Personal Information</h2>
    <dl class="attribute-list">
      <dt class="attribute-list__key">Name</dt>
      <dd class="attribute-list__value"><%= attributes['name'] %></dd>
      
      <dt class="attribute-list__key">Email</dt>
      <dd class="attribute-list__value">
        <% if attributes['email'].present? %>
          <a href="mailto:<%= attributes['email'] %>"><%= attributes['email'] %></a>
        <% else %>
          Not provided
        <% end %>
      </dd>
      
      <dt class="attribute-list__key">Address</dt>
      <dd class="attribute-list__value">
        <% if attributes['address'].present? %>
          <%= simple_format(attributes['address']) %>
        <% else %>
          Not provided
        <% end %>
      </dd>
      
      <dt class="attribute-list__key">Phone</dt>
      <dd class="attribute-list__value"><%= attributes['phone'] || 'Not provided' %></dd>
      
      <dt class="attribute-list__key">Temple Affiliation</dt>
      <dd class="attribute-list__value">
        <% if attributes['affiliation'].present? %>
          <% 
            affiliation_labels = {
              'temple' => 'Temple University Affiliates',
              'non-temple' => 'Non-Temple Affiliates'
            }
          %>
          <%= affiliation_labels[attributes['affiliation']] || attributes['affiliation'] %>
        <% else %>
          Not provided
        <% end %>
      </dd>

      <% if @form_submission.form_type == 'av-requests' %>
        <dt class="attribute-list__key">Outside Vendor Fees</dt>
        <dd class="attribute-list__value">
          <% vendor_fees_value = raw_attributes['outside_vendor_fees'] %>
          <% if ['1', '1.0', 1, true, 'true', 'on'].include?(vendor_fees_value) %>
            <span class="badge badge-success">✓ Acknowledged</span>
          <% else %>
            <span class="badge badge-secondary">Not acknowledged</span>
          <% end %>
        </dd>
      <% end %>
      
      <dt class="attribute-list__key">Duplication Limits</dt>
      <dd class="attribute-list__value">
        <% duplication_limits_value = raw_attributes['duplication_limits'] %>
        <% if ['1', '1.0', 1, true, 'true', 'on'].include?(duplication_limits_value) %>
          <span class="badge badge-success">✓ Acknowledged</span>
        <% else %>
          <span class="badge badge-secondary">Not acknowledged</span>
        <% end %>
      </dd>
      
      <dt class="attribute-list__key">Copyright Acknowledgment</dt>
      <dd class="attribute-list__value">
        <% copyright_value = raw_attributes['copyright_acknowledgment'] %>
        <% if ['1', '1.0', 1, true, 'true', 'on'].include?(copyright_value) %>
          <span class="badge badge-success">✓ Acknowledged</span>
        <% else %>
          <span class="badge badge-secondary">Not acknowledged</span>
        <% end %>
      </dd>
    </dl>

    <hr class="divider">

    <!-- Request Information -->
    <h2 class="section-title">Request Information</h2>
    <div class="requests-list">
      <% request_count = 0 %>
      <% (0..9).each do |i| %>
        <% 
          # Determine field suffixes for this request group
          collection_field = i == 0 ? 'collection_title' : "collection_title_#{i.to_s.rjust(2, '0')}"
          
          # Check if this request group has required data
          if @form_submission.form_type == 'av-requests'
            identifier_field = i == 0 ? 'identifier' : "identifier_#{i.to_s.rjust(2, '0')}"
            notes_field = i == 0 ? 'notes' : "notes_#{i.to_s.rjust(2, '0')}"
            format_field = i == 0 ? 'format' : "format_#{i.to_s.rjust(2, '0')}"
            
            has_data = attributes[collection_field].present? && 
                       attributes[identifier_field].present? &&  
                       attributes[format_field].present?
          else
            # Copy requests
            box_field = i == 0 ? 'box' : "box_#{i.to_s.rjust(2, '0')}"
            folder_field = i == 0 ? 'folder' : "folder_#{i.to_s.rjust(2, '0')}"
            identifier_field = i == 0 ? 'identifier' : "identifier_#{i.to_s.rjust(2, '0')}"
            pages_field = i == 0 ? 'estimated_pages' : "estimated_pages_#{i.to_s.rjust(2, '0')}"
            format_field = i == 0 ? 'format' : "format_#{i.to_s.rjust(2, '0')}"
            
            has_data = attributes[collection_field].present? && 
                       attributes[box_field].present? &&
                       attributes[folder_field].present? &&
                       attributes[identifier_field].present? &&  
                       attributes[format_field].present?
          end
        %>
        
        <% if has_data %>
          <% request_count += 1 %>
          <div class="request-item">
            <h3 class="request-number">Request <%= request_count %></h3>
            <div class="request-content">
              <dl class="attribute-list">
                <dt class="attribute-list__key">Collection Title</dt>
                <dd class="attribute-list__value"><%= attributes[collection_field] %></dd>
                
                <% if @form_submission.form_type == 'av-requests' %>
                  <dt class="attribute-list__key">Identifier/File Name/Description</dt>
                  <dd class="attribute-list__value"><%= attributes[identifier_field] %></dd>
                  
                  <dt class="attribute-list__key">Notes</dt>
                  <dd class="attribute-list__value">
                    <% if attributes[notes_field].present? %>
                      <%= simple_format(attributes[notes_field]) %>
                    <% else %>
                      Not provided
                    <% end %>
                  </dd>
                  
                  <dt class="attribute-list__key">Format</dt>
                  <dd class="attribute-list__value">
                    <% if attributes[format_field].present? %>
                      <% 
                        format_labels = {
                          'film' => 'Film: $30 per minute',
                          'video' => 'Video: $50 per tape',
                          'audio' => 'Audio: $50 per tape/reel'
                        }
                      %>
                      <%= format_labels[attributes[format_field]] || attributes[format_field] %>
                    <% else %>
                      Not provided
                    <% end %>
                  </dd>
                <% else %>
                  <dt class="attribute-list__key">Box</dt>
                  <dd class="attribute-list__value"><%= attributes[box_field] %></dd>
                  
                  <dt class="attribute-list__key">Folder</dt>
                  <dd class="attribute-list__value"><%= attributes[folder_field] %></dd>
                  
                  <dt class="attribute-list__key">Title/Identifier/File Name/Description</dt>
                  <dd class="attribute-list__value"><%= attributes[identifier_field] %></dd>
                  
                  <dt class="attribute-list__key">Estimated Pages</dt>
                  <dd class="attribute-list__value"><%= attributes[pages_field] || 'Not provided' %></dd>
                  
                  <dt class="attribute-list__key">Format</dt>
                  <dd class="attribute-list__value">
                    <% if attributes[format_field].present? %>
                      <% 
                        format_labels = {
                          'tiff' => 'TIFF (600 DPI): $5 per image',
                          'pdf' => 'PDF: $0.50 per page',
                          'photocopy' => 'Photocopy: $0.50 per page plus postage'
                        }
                      %>
                      <%= format_labels[attributes[format_field]] || attributes[format_field] %>
                    <% else %>
                      Not provided
                    <% end %>
                  </dd>
                <% end %>
              </dl>
            </div>
          </div>
        <% end %>
      <% end %>
      
      <% if request_count == 0 %>
        <p class="no-requests">No requests specified.</p>
      <% end %>
    </div>
</section>
