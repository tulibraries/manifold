<% content_for(:title) { "AV Request ##{@form_submission.id}" } %>

<header class="main-content__header">
  <h1 class="main-content__page-title">
    <%= content_for(:title) %>
  </h1>
  
  <div class="main-content__header-actions">
    <%= link_to "← Back to List", admin_form_submissions_path, class: "button" %>
  </div>
</header>

<section class="main-content__body">
  <% begin %>
    <% raw_attributes = @form_submission.form_attributes %>
    <% # Handle nested form structure - extract from 'form' key if present %>
    <% attributes = raw_attributes['form'] || raw_attributes %>
    
    <!-- Submission Details -->
    <div class="attribute-list">      
      <dt class="attribute-list__key">Submitted At</dt>
      <dd class="attribute-list__value"><%= @form_submission.created_at.strftime('%B %d, %Y at %l:%M %p') %></dd>
    </div>

    <hr class="divider">

    <!-- Personal Information -->
    <h2 class="section-title">Personal Information</h2>
    <div class="attribute-list">
      <dt class="attribute-list__key">Name</dt>
      <dd class="attribute-list__value"><%= attributes['name'] %></dd>
      
      <dt class="attribute-list__key">Email</dt>
      <dd class="attribute-list__value">
        <% if attributes['email'].present? %>
          <a href="mailto:<%= attributes['email'] %>"><%= attributes['email'] %></a>
        <% else %>
          Not provided
        <% end %>
      </dd>
      
      <dt class="attribute-list__key">Phone</dt>
      <dd class="attribute-list__value"><%= attributes['phone'] || 'Not provided' %></dd>
      
      <dt class="attribute-list__key">Temple Affiliation</dt>
      <dd class="attribute-list__value">
        <% if attributes['affiliation'].present? %>
          <% 
            affiliation_labels = {
              'temple' => 'Temple University Affiliates',
              'non-temple' => 'Non-Temple Affiliates'
            }
          %>
          <%= affiliation_labels[attributes['affiliation']] || attributes['affiliation'] %>
        <% else %>
          Not provided
        <% end %>
      </dd>
      
      <dt class="attribute-list__key">Address</dt>
      <dd class="attribute-list__value">
        <% if attributes['address'].present? %>
          <%= simple_format(attributes['address']) %>
        <% else %>
          Not provided
        <% end %>
      </dd>
      
      <dt class="attribute-list__key">Outside Vendor Fees</dt>
      <dd class="attribute-list__value">
        <span class="badge badge-success">✓ Acknowledged</span>
      </dd>
      
      <dt class="attribute-list__key">Duplication Limits</dt>
      <dd class="attribute-list__value">
        <span class="badge badge-success">✓ Acknowledged</span>
      </dd>
      
      <dt class="attribute-list__key">Copyright Acknowledgment</dt>
      <dd class="attribute-list__value">
        <span class="badge badge-success">✓ Acknowledged</span>
      </dd>
      
      <dt class="attribute-list__key">TU ID</dt>
      <dd class="attribute-list__value"><%= attributes['tu_id'] %></dd>
      
      <dt class="attribute-list__key">Department</dt>
      <dd class="attribute-list__value"><%= attributes['department'] %></dd>
      
      <% if attributes['affiliation_other'].present? %>
        <dt class="attribute-list__key">Other Affiliation</dt>
        <dd class="attribute-list__value"><%= attributes['affiliation_other'] %></dd>
      <% end %>
    </div>

    <hr class="divider">

    <!-- Request Information -->
    <h2 class="section-title">Request Information</h2>
    <div class="requests-list">
      <% request_count = 0 %>
      <% (0..9).each do |i| %>
        <% 
          # Determine field suffixes for this request group
          collection_field = i == 0 ? 'collection_title' : "collection_title_#{i.to_s.rjust(2, '0')}"
          identifier_field = i == 0 ? 'identifier' : "identifier_#{i.to_s.rjust(2, '0')}"
          notes_field = i == 0 ? 'notes' : "notes_#{i.to_s.rjust(2, '0')}"
          format_field = i == 0 ? 'format' : "format_#{i.to_s.rjust(2, '0')}"
          
          # Check if this request group has required data
          has_data = attributes[collection_field].present? && 
                      attributes[identifier_field].present? &&  
                      attributes[format_field].present?
        %>
        
        <% if has_data %>
          <% request_count += 1 %>
          <div class="request-item">
            <h3 class="request-number">Request <%= request_count %></h3>
            <div class="request-content">
              <div class="request-field-group">
                <div class="row">
                  <div class="col-md-6">
                    <strong>Collection Title:</strong>
                    <div class="field-value"><%= attributes[collection_field] %></div>
                  </div>
                  <div class="col-md-6">
                    <strong>Identifier/File Name/Description:</strong>
                    <div class="field-value"><%= attributes[identifier_field] %></div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <strong>Notes:</strong>
                    <div class="field-value">
                      <% if attributes[notes_field].present? %>
                        <%= simple_format(attributes[notes_field]) %>
                      <% else %>
                        Not provided
                      <% end %>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <strong>Format:</strong>
                    <div class="field-value">
                      <% if attributes[format_field].present? %>
                        <% 
                          format_labels = {
                            'film' => 'Film: $30 per minute',
                            'video' => 'Video: $50 per tape',
                            'audio' => 'Audio: $50 per tape/reel'
                          }
                        %>
                        <%= format_labels[attributes[format_field]] || attributes[format_field] %>
                      <% else %>
                        Not provided
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
      
      <% if request_count == 0 %>
        <p class="no-requests">No requests specified.</p>
      <% end %>
    </div>

    <hr class="divider">

    <!-- Additional Information -->
    <% # Exclude system fields and form fields we've already displayed %>
    <% excluded_fields = ['name', 'email', 'tu_id', 'phone', 'department', 'affiliation', 'affiliation_other', 'form_type', 'title', 'recipients'] %>
    <% request_fields = [] %>
    <% (0..9).each do |i| %>
      <% if i == 0 %>
        <% request_fields += ['collection_title', 'identifier', 'notes', 'format'] %>
      <% else %>
        <% suffix = i.to_s.rjust(2, '0') %>
        <% request_fields += ["collection_title_#{suffix}", "identifier_#{suffix}", "notes_#{suffix}", "format_#{suffix}"] %>
      <% end %>
    <% end %>
    <% system_fields = ['authenticity_token', 'controller', 'action'] %>
    <% additional_fields = attributes.except(*(excluded_fields + request_fields + system_fields)) %>
    
    <% if additional_fields.any? %>
      <h2 class="section-title">Additional Information</h2>
      <div class="attribute-list">
        <% additional_fields.each do |key, value| %>
          <% if value.present? %>
            <dt class="attribute-list__key"><%= key.humanize %></dt>
            <dd class="attribute-list__value"><%= simple_format(value) %></dd>
          <% end %>
        <% end %>
      </div>
    <% end %>

  <% rescue => e %>
    <div class="error-message">
      <h2>Error Loading Submission Details</h2>
      <p>There was an error decrypting the form data for this submission.</p>
      <p><strong>Error:</strong> <%= e.message %></p>
      
      <div class="attribute-list">
        <dt class="attribute-list__key">Submission ID</dt>
        <dd class="attribute-list__value">#<%= @form_submission.id %></dd>
        
        <dt class="attribute-list__key">Form Type</dt>
        <dd class="attribute-list__value"><%= @form_submission.form_type %></dd>
        
        <dt class="attribute-list__key">Submitted At</dt>
        <dd class="attribute-list__value"><%= @form_submission.created_at.strftime('%B %d, %Y at %l:%M %p') %></dd>
      </div>
    </div>
  <% end %>
</section>

<style>
  .section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin: 2rem 0 1rem 0;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
  }
  
  .attribute-list {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 1rem 2rem;
    margin-bottom: 1.5rem;
  }
  
  .attribute-list__key {
    font-weight: 600;
    color: #555;
    margin: 0;
  }
  
  .attribute-list__value {
    margin: 0;
    word-wrap: break-word;
  }
  
  .divider {
    border: 0;
    height: 1px;
    background: #e9ecef;
    margin: 2rem 0;
  }
  
  .requests-list {
    margin: 1rem 0;
  }
  
  .request-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .request-number {
    font-size: 1rem;
    font-weight: 600;
    color: #495057;
    margin: 0 0 0.5rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
  }
  
  .request-content {
    color: #333;
    line-height: 1.5;
  }
  
  .request-field-group .row {
    margin-bottom: 1rem;
  }
  
  .request-field-group .row:last-child {
    margin-bottom: 0;
  }
  
  .field-value {
    margin-top: 0.25rem;
    padding: 0.5rem;
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    min-height: 2.5rem;
    display: flex;
    align-items: center;
  }
  
  .no-requests {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 6px;
  }
  
  .error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 1.5rem;
    border-radius: 6px;
    margin-bottom: 1rem;
  }
  
  .error-message h2 {
    color: #721c24;
    margin-top: 0;
  }
  
  .main-content__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  
  .main-content__header-actions {
    margin-left: auto;
  }
</style>
