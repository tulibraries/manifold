<% content_for(:title) { @page_title } %>

<header class="main-content__header">
  <h1 class="main-content__page-title">
    <%= @page_title %>
  </h1>
  
  <div class="main-content__header-actions">
    <% if params[:action] == 'av_requests' %>
      <%= link_to "Export CSV", export_av_requests_csv_admin_form_submissions_path(format: :csv), 
          class: "button button--export",
          title: "Download all AV requests as CSV for Excel" %>
    <% elsif params[:action] == 'copy_requests' %>
      <%= link_to "Export CSV", export_copy_requests_csv_admin_form_submissions_path(format: :csv), 
          class: "button button--export",
          title: "Download all copy requests as CSV for Excel" %>
    <% end %>
    
    <%= link_to "← Back to Form Submissions", admin_form_submissions_path, 
        class: "button button--secondary" %>
  </div>
</header>

<section class="main-content__body main-content__body--flush">
  <% if @form_submissions.any? %>
    <div class="table">
      <table class="table__table">
        <thead>
          <tr class="table__row table__row--header">
            <th class="table__header cell cell--header">Submitted</th>
            <th class="table__header cell cell--header">Name</th>
            <th class="table__header cell cell--header">Email</th>
            <th class="table__header cell cell--header">Requests</th>
          </tr>
        </thead>
        <tbody>
          <% @form_submissions.each do |submission| %>
            <tr class="table__row table__row--clickable" onclick="window.location='<%= admin_form_submission_path(submission, form_type: submission.form_type) %>'">
              <td class="cell cell--date-time">
                <%= submission.created_at.strftime('%m/%d/%Y %l:%M %p') %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <%= attributes['name'] || 'N/A' %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <%= attributes['email'] || 'N/A' %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
              <td class="cell">
                <% begin %>
                  <% raw_attributes = submission.form_attributes %>
                  <% attributes = raw_attributes['form'] || raw_attributes %>
                  <% request_count = 0 %>
                  <% (0..9).each do |i| %>
                    <% 
                      collection_field = i == 0 ? 'collection_title' : "collection_title_#{i.to_s.rjust(2, '0')}"
                      
                      if submission.form_type == 'av-requests'
                        identifier_field = i == 0 ? 'identifier' : "identifier_#{i.to_s.rjust(2, '0')}"
                        format_field = i == 0 ? 'format' : "format_#{i.to_s.rjust(2, '0')}"
                        has_data = attributes[collection_field].present? && 
                                   attributes[identifier_field].present? && 
                                   attributes[format_field].present?
                      else
                        # Copy requests
                        box_field = i == 0 ? 'box' : "box_#{i.to_s.rjust(2, '0')}"
                        folder_field = i == 0 ? 'folder' : "folder_#{i.to_s.rjust(2, '0')}"
                        identifier_field = i == 0 ? 'identifier' : "identifier_#{i.to_s.rjust(2, '0')}"
                        format_field = i == 0 ? 'format' : "format_#{i.to_s.rjust(2, '0')}"
                        has_data = attributes[collection_field].present? && 
                                   attributes[box_field].present? && 
                                   attributes[folder_field].present? && 
                                   attributes[identifier_field].present? && 
                                   attributes[format_field].present?
                      end
                    %>
                    <% if has_data %>
                      <% request_count += 1 %>
                    <% end %>
                  <% end %>
                  <%= pluralize(request_count, 'request') %>
                <% rescue %>
                  <em>Error decrypting</em>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="table">
      <div class="table__empty-state">
        <h3 class="table__empty-state-title">No submissions found</h3>
        <p class="table__empty-state-text">
          There are no <%= @page_title.downcase %> to display.
        </p>
      </div>
    </div>
  <% end %>
  
  <% if @form_submissions.respond_to?(:current_page) %>
    <div class="pagination-wrapper">
      <%= paginate @form_submissions %>
    </div>
  <% end %>
</section>
